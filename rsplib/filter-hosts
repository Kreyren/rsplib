#!/bin/bash

. ./planetlab-config


showbad=0
testhosts=0
if [ "x$1" = "x-showbad" ] ; then
   shift
   showbad=1
   testhosts=0
elif [ "x$1" = "x-test" ] ; then
   shift
   showbad=1
   testhosts=1
fi

SERVER_LIST=`\
( \
while [ x$1 != "x" ] ; do \
   echo $1 && \
   shift ; \
done \
) | sort -u`


good=0
bad=0
for SERVER in $SERVER_LIST; do
   isgood=0
   if [ $testhosts = 1 ] ; then
      echo "# Testing $SERVER ..."
   fi
   if ssh -C -i $PLANETLAB_KEY -oPasswordAuthentication=no $PLANETLAB_USER@$SERVER "echo \"$SERVER is ready!\"" 2>/dev/null 1>/dev/null ; then
      isgood=1
   fi

   if [ $isgood = 1 ] ; then
      echo "$SERVER"
      let "good+=1"
   else
      if [ $showbad = 1 ] ; then
         echo "# --- $SERVER"
      fi
      let "bad+=1"
   fi
done

if [ $showbad = 1 ] ; then
   echo "# Good: $good   Bad: $bad"
fi
